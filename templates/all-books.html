{% extends "base.html" %} {# Use base template layout #}

{% block title %}All Books{% endblock %} {# Page title #}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='all-books.css') }}"> <!-- Page CSS -->
{% endblock %}

{% block content %}

<h1 class="mb-4">Search Books</h1> <!-- Page heading -->

<!-- ===================== FILTER CARD ===================== -->
<div class="card mb-4"> <!-- Filter container card -->
  <div class="card-body"> <!-- Card padding -->
    <form id="filterForm" class="row g-3"> <!-- Filter form (Bootstrap grid) -->

      <div class="col-md-4"> <!-- Search input column -->
        <label for="search" class="form-label">Search</label> <!-- Label -->
        <input type="text" class="form-control" id="search" placeholder="Search by title or author..."> <!-- Input -->
      </div>

      <div class="col-md-3"> <!-- Genre dropdown column -->
        <label for="genre" class="form-label">Genre</label>
        <select class="form-select" id="genre"> <!-- Genre select -->
          <option value="">All Genres</option> <!-- Default -->
          {% for genre in genres %} <!-- Loop genres from backend -->
          <option value="{{ genre.name }}">{{ genre.name }}</option> <!-- Genre option -->
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3"> <!-- Language dropdown column -->
        <label for="lang" class="form-label">Language</label>
        <select class="form-select" id="lang"> <!-- Language select -->
          <option value="">All Languages</option> <!-- Default -->
          <option value="English">English</option>
          <option value="Albanian">Albanian</option>
          <option value="Spanish">Spanish</option>
          <option value="French">French</option>
        </select>
      </div>

      <div class="col-md-2"> <!-- Filter button column -->
        <label class="form-label">&nbsp;</label> <!-- Keeps button aligned -->
        <button type="submit" class="btn btn-dark w-100">Filter</button> <!-- Submit filter -->
      </div>

      <div class="col-12"> <!-- Tabs row -->
        <div class="btn-group" role="group"> <!-- Toggle buttons -->
          <button type="button" class="btn btn-outline-dark active" id="tabAll">All Books</button> <!-- All tab -->
          <button type="button" class="btn btn-outline-dark" id="tabAvail">Available Only</button> <!-- Available tab -->
        </div>
      </div>

    </form>
  </div>
</div>

<!-- ===================== BOOKS GRID ===================== -->
<div class="row" id="booksGrid">
  <!-- Books are injected here by JS -->
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() { // Run after page loads

  let currentFilter = "all"; // Track active filter tab ("all" or "available")

  // Load books from the API using filter + query params
  function loadBooks(filter = "all", search = "", genre = "", lang = "") {

    let url = "/api/books?"; // Base endpoint

    if (filter === "available") url += "available=true&"; // Only available books
    if (search) url += `search=${encodeURIComponent(search)}&`; // Search title/author
    if (genre) url += `genre=${encodeURIComponent(genre)}&`; // Filter by genre
    if (lang) url += `language=${encodeURIComponent(lang)}&`; // Filter by language

    fetch(url) // Call backend API
      .then(res => res.json()) // Convert response to JSON
      .then(data => {
        displayBooks(data.books || []); // Render books into grid
      })
      .catch(err => console.error("Error:", err)); // Log error
  }

  // Render books into the grid as cards
  function displayBooks(books) {
    const grid = document.getElementById("booksGrid"); // Grid container

    if (books.length === 0) { // No results
      grid.innerHTML = '<div class="col-12"><div class="alert alert-info">No books found.</div></div>';
      return; // Stop here
    }

    // Convert each book to an HTML card and insert into the page
    grid.innerHTML = books.map(book => `

      <div class="col-md-4 mb-4"> <!-- Card column -->
        <div class="card h-100"> <!-- Card full height -->
          <div class="card-body"> <!-- Card content -->

            <h5 class="card-title">${book.title || 'Untitled'}</h5> <!-- Book title -->
            <p class="card-text"><strong>Author:</strong> ${book.author || 'Unknown'}</p> <!-- Author -->
            <p class="card-text"><strong>Year:</strong> ${book.year || 'N/A'}</p> <!-- Year -->
            <p class="card-text"><strong>Genre:</strong> ${book.genre || 'N/A'}</p> <!-- Genre -->

            <!-- Status badge: uses book.available (true/false) -->
            <span class="badge ${book.available ? 'bg-success' : 'bg-secondary'}">
              ${book.available ? 'Available' : 'Borrowed'}
            </span>

          </div>

          <div class="card-footer"> <!-- Footer actions -->
            <a href="/book/${book._id}" class="btn btn-primary btn-sm">View Details</a> <!-- Details link -->
          </div>

        </div>
      </div>

    `).join(''); // Join all cards into one string
  }

  // Handle filter form submit (search/genre/lang)
  document.getElementById("filterForm").addEventListener("submit", function(e) {
    e.preventDefault(); // Prevent reload

    const search = document.getElementById("search").value; // Read search input
    const genre = document.getElementById("genre").value; // Read genre dropdown
    const lang = document.getElementById("lang").value; // Read language dropdown

    loadBooks(currentFilter, search, genre, lang); // Fetch filtered results
  });

  // "All Books" tab click
  document.getElementById("tabAll").addEventListener("click", function() {
    currentFilter = "all"; // Switch mode

    this.classList.add("active"); // Highlight this tab
    document.getElementById("tabAvail").classList.remove("active"); // Unhighlight other

    loadBooks(currentFilter); // Reload list
  });

  // "Available Only" tab click
  document.getElementById("tabAvail").addEventListener("click", function() {
    currentFilter = "available"; // Switch mode

    this.classList.add("active"); // Highlight this tab
    document.getElementById("tabAll").classList.remove("active"); // Unhighlight other

    loadBooks(currentFilter); // Reload list
  });

  loadBooks(); // Initial load on first page open

  // Refresh list when another page triggers "bookReturned"
  window.addEventListener('bookReturned', function() {
    loadBooks(currentFilter); // Reload with current filter
  });

});
</script>
{% endblock %}
