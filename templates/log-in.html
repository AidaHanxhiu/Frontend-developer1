{# Extend the base layout template (navbar, footer, etc.) #}
{% extends "base.html" %}

{# Set the page title shown in the browser tab #}
{% block title %}Login{% endblock %}

{# Page-specific CSS block #}
{% block extra_css %}
<!-- Link to the login page stylesheet -->
<link rel="stylesheet" href="{{ url_for('static', filename='log-in.css') }}">
{% endblock %}

{# Main content block #}
{% block content %}

<!-- Page heading -->
<h1>Library Management â€“ Sign in</h1>

<!-- Login form -->
<form id="login-form" class="login-form">

    <!-- Email label -->
    <label for="email">Email</label>

    <!-- Email input field (required) -->
    <input type="email"
           id="email"
           name="email"
           placeholder="Enter your email"
           required>

    <!-- Password label -->
    <label for="password">Password</label>

    <!-- Password input field (required) -->
    <input type="password"
           id="password"
           name="password"
           placeholder="Enter your password"
           required>

    <!-- Forgot password link -->
    <p>
      <a href="{{ url_for('pages.forgot_password') }}">
        Forgot password?
      </a>
    </p>

    <!-- Submit button -->
    <button type="submit" class="btn-primary">
      Sign In
    </button>
</form>

<!-- Message area for login feedback -->
<p id="login-message" style="margin-top: 10px;"></p>

<!-- Horizontal divider -->
<hr>

<!-- Sign-up prompt -->
<p>
    Don't have an account?
    <!-- Link to sign-up page -->
    <a href="{{ url_for('pages.sign_up') }}">Sign up</a>
</p>

{# End of main content block #}
{% endblock %}

{# Page-specific JavaScript block #}
{% block extra_js %}
<script>
/* Run JavaScript after the DOM is fully loaded */
document.addEventListener("DOMContentLoaded", function () {

    /* Get reference to the login form */
    const form = document.getElementById("login-form");

    /* Get reference to the message display element */
    const messageEl = document.getElementById("login-message");

    /* Listen for form submission */
    form.addEventListener("submit", async function (event) {

        /* Prevent default form submission (page reload) */
        event.preventDefault();

        /* Show loading message */
        messageEl.textContent = "Signing in...";
        messageEl.style.color = "black";

        /* Read email input value */
        const email = document.getElementById("email").value;

        /* Read password input value */
        const password = document.getElementById("password").value;

        try {
            /* Send login request to backend API */
            const response = await fetch("/api/login", {

                /* HTTP method */
                method: "POST",

                /* Set request headers */
                headers: { "Content-Type": "application/json" },

                /* Send email and password as JSON */
                body: JSON.stringify({ email, password }),
            });

            /* Parse JSON response */
            const data = await response.json();

            /* If login is successful */
            if (response.ok) {

                /* Show success message */
                messageEl.textContent = data.message;
                messageEl.style.color = "green";

                /* Redirect user based on role */
                if (data.role === "admin") {
                    window.location.href = "/admin";
                } else {
                    window.location.href = "/my-books";
                }

            } else {
                /* Show error message for invalid login */
                messageEl.textContent = data.message || "Invalid credentials";
                messageEl.style.color = "red";
            }

        } catch (error) {
            /* Log error to console */
            console.error(error);

            /* Show server connection error */
            messageEl.textContent = "Error connecting to server";
            messageEl.style.color = "red";
        }
    });
});
</script>
{% endblock %}
