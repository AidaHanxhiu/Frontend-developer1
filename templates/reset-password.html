{% extends "base.html" %}

{% block title %}Reset Password{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='forgot-password.css') }}">
{% endblock %}

{% block content %}

<div class="row justify-content-center">
  <div class="col-md-6">
    <h1 class="mb-4">Reset your password</h1>

    {% if not valid_token %}
    <div class="alert alert-danger">
      <i class="bi bi-exclamation-triangle"></i> Invalid or expired reset link. 
      Please request a new password reset.
    </div>
    <a href="{{ url_for('pages.forgot_password') }}" class="btn btn-primary">Request new reset link</a>
    {% else %}
    <div class="card">
      <div class="card-body">
        <form id="resetPasswordForm">
          <input type="hidden" id="token" value="{{ token }}">
          <div class="mb-3">
            <label for="new_password" class="form-label">New Password</label>
            <input type="password" class="form-control" id="new_password" required minlength="6">
            <small class="form-text text-muted">Password must be at least 6 characters</small>
          </div>
          <div class="mb-3">
            <label for="confirm_password" class="form-label">Confirm Password</label>
            <input type="password" class="form-control" id="confirm_password" required minlength="6">
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-key"></i> Reset Password
          </button>
        </form>
        <div id="message" class="mt-3"></div>
      </div>
    </div>
    {% endif %}

    <p class="mt-3">
      <a href="{{ url_for('pages.log_in') }}">Back to sign in</a>
    </p>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.getElementById("resetPasswordForm");
  if (form) {
    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const token = document.getElementById("token").value;
      const newPassword = document.getElementById("new_password").value;
      const confirmPassword = document.getElementById("confirm_password").value;
      const messageEl = document.getElementById("message");
      
      // Validate passwords match
      if (newPassword !== confirmPassword) {
        messageEl.innerHTML = '<div class="alert alert-danger">Passwords do not match</div>';
        return;
      }
      
      // Validate password length
      if (newPassword.length < 6) {
        messageEl.innerHTML = '<div class="alert alert-danger">Password must be at least 6 characters</div>';
        return;
      }
      
      // Show loading message
      messageEl.innerHTML = '<div class="alert alert-info">Resetting password...</div>';
      
      // Send request to API
      fetch("/api/reset-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          token: token,
          new_password: newPassword
        })
      })
      .then(res => {
        return res.json().then(data => ({ status: res.ok, data: data }));
      })
      .then(result => {
        if (result.status) {
          messageEl.innerHTML = '<div class="alert alert-success">' + 
            '<i class="bi bi-check-circle"></i> ' +
            'Password reset successfully! Redirecting to login...</div>';
          setTimeout(() => {
            window.location.href = "{{ url_for('pages.log_in') }}";
          }, 2000);
        } else {
          messageEl.innerHTML = '<div class="alert alert-danger">' + 
            '<i class="bi bi-exclamation-triangle"></i> ' +
            (result.data.message || 'Failed to reset password') + '</div>';
        }
      })
      .catch(err => {
        messageEl.innerHTML = '<div class="alert alert-danger">Error resetting password</div>';
        console.error(err);
      });
    });
  }
});
</script>
{% endblock %}
