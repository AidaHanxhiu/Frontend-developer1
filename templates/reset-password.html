{# Extend the base layout template (navbar, footer, shared layout) #}
{% extends "base.html" %}

{# Set the page title shown in the browser tab #}
{% block title %}Reset Password{% endblock %}

{# Page-specific CSS block #}
{% block extra_css %}
<!-- Link to the forgot/reset password stylesheet -->
<link rel="stylesheet" href="{{ url_for('static', filename='forgot-password.css') }}">
{% endblock %}

{# Main content block #}
{% block content %}

<!-- Center the reset password content horizontally -->
<div class="row justify-content-center">

  <!-- Medium-width column -->
  <div class="col-md-6">

    <!-- Page heading -->
    <h1 class="mb-4">Reset your password</h1>

    {# Check if the reset token is invalid or expired #}
    {% if not valid_token %}

    <!-- Error alert for invalid/expired token -->
    <div class="alert alert-danger">
      <i class="bi bi-exclamation-triangle"></i>
      Invalid or expired reset link.
      Please request a new password reset.
    </div>

    <!-- Link to request a new password reset -->
    <a href="{{ url_for('pages.forgot_password') }}"
       class="btn btn-primary">
      Request new reset link
    </a>

    {% else %}

    <!-- Card container for reset password form -->
    <div class="card">
      <div class="card-body">

        <!-- Reset password form -->
        <form id="resetPasswordForm">

          <!-- Hidden input to store reset token -->
          <input type="hidden" id="token" value="{{ token }}">

          <!-- New password input -->
          <div class="mb-3">
            <label for="new_password" class="form-label">
              New Password
            </label>
            <input type="password"
                   class="form-control"
                   id="new_password"
                   required
                   minlength="6">
            <!-- Password requirement hint -->
            <small class="form-text text-muted">
              Password must be at least 6 characters
            </small>
          </div>

          <!-- Confirm password input -->
          <div class="mb-3">
            <label for="confirm_password" class="form-label">
              Confirm Password
            </label>
            <input type="password"
                   class="form-control"
                   id="confirm_password"
                   required
                   minlength="6">
          </div>

          <!-- Submit button -->
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-key"></i> Reset Password
          </button>
        </form>

        <!-- Area for displaying success or error messages -->
        <div id="message" class="mt-3"></div>
      </div>
    </div>

    {% endif %}

    <!-- Link back to login page -->
    <p class="mt-3">
      <a href="{{ url_for('pages.log_in') }}">
        Back to sign in
      </a>
    </p>
  </div>
</div>

{# End of main content block #}
{% endblock %}

{# Page-specific JavaScript block #}
{% block extra_js %}
<script>
/* Run JavaScript after the DOM has fully loaded */
document.addEventListener("DOMContentLoaded", function() {

  /* Get reference to the reset password form */
  const form = document.getElementById("resetPasswordForm");

  /* Check if the form exists (token is valid) */
  if (form) {

    /* Attach submit event listener */
    form.addEventListener("submit", function(e) {

      /* Prevent default form submission */
      e.preventDefault();

      /* Retrieve reset token from hidden input */
      const token = document.getElementById("token").value;

      /* Retrieve new password value */
      const newPassword = document.getElementById("new_password").value;

      /* Retrieve confirm password value */
      const confirmPassword = document.getElementById("confirm_password").value;

      /* Get reference to message display element */
      const messageEl = document.getElementById("message");
      
      /* Validate that passwords match */
      if (newPassword !== confirmPassword) {
        messageEl.innerHTML =
          '<div class="alert alert-danger">Passwords do not match</div>';
        return;
      }
      
      /* Validate password length */
      if (newPassword.length < 6) {
        messageEl.innerHTML =
          '<div class="alert alert-danger">Password must be at least 6 characters</div>';
        return;
      }
      
      /* Show loading message */
      messageEl.innerHTML =
        '<div class="alert alert-info">Resetting password...</div>';
      
      /* Send POST request to reset password API */
      fetch("/api/reset-password", {

        /* HTTP method */
        method: "POST",

        /* Set request headers */
        headers: { "Content-Type": "application/json" },

        /* Send token and new password as JSON */
        body: JSON.stringify({ 
          token: token,
          new_password: newPassword
        })
      })

      /* Parse response and preserve HTTP status */
      .then(res => {
        return res.json().then(data => ({
          status: res.ok,
          data: data
        }));
      })

      /* Handle API response */
      .then(result => {

        /* If password reset was successful */
        if (result.status) {

          /* Show success message */
          messageEl.innerHTML =
            '<div class="alert alert-success">' +
            '<i class="bi bi-check-circle"></i> ' +
            'Password reset successfully! Redirecting to login...</div>';

          /* Redirect to login page after delay */
          setTimeout(() => {
            window.location.href = "{{ url_for('pages.log_in') }}";
          }, 2000);

        } else {

          /* Show error message from backend */
          messageEl.innerHTML =
            '<div class="alert alert-danger">' +
            '<i class="bi bi-exclamation-triangle"></i> ' +
            (result.data.message || 'Failed to reset password') +
            '</div>';
        }
      })

      /* Handle network or server errors */
      .catch(err => {
        messageEl.innerHTML =
          '<div class="alert alert-danger">Error resetting password</div>';
        console.error(err);
      });
    });
  }
});
</script>
{% endblock %}
