{% extends "base.html" %}

{% block title %}My Books{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='my-books.css') }}">
{% endblock %}

{% block content %}

<h1 class="mb-4">My Borrowed Books</h1>

<div id="loansList" class="row">
  <!-- Loans will be loaded here -->
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  function loadLoans() {
    fetch("/api/loans")
      .then(res => res.json())
      .then(data => {
        displayLoans(data.loans || []);
      })
      .catch(err => console.error("Error:", err));
  }
  
  function displayLoans(loans) {
    const loansList = document.getElementById("loansList");
    
    if (loans.length === 0) {
      loansList.innerHTML = `
        <div class="col-12">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> You don't have any loans yet. 
            <a href="{{ url_for('pages.all_books') }}">Browse books</a> to get started!
          </div>
        </div>
      `;
      return;
    }
    
    loansList.innerHTML = loans.map(loan => {
      const borrowedDate = loan.borrowed_date ? new Date(loan.borrowed_date).toLocaleDateString() : 'N/A';
      const dueDate = loan.due_date ? new Date(loan.due_date).toLocaleDateString() : 'N/A';
      const isOverdue = loan.due_date && new Date(loan.due_date) < new Date() && loan.status === "active";
      const bookTitle = loan.book && loan.book.title ? loan.book.title : 'Unknown Book';
      const bookAuthor = loan.book && loan.book.author ? loan.book.author : 'Unknown Author';
      
      return `
        <div class="col-md-6 mb-3">
          <div class="card ${isOverdue ? 'border-danger' : ''}">
            <div class="card-body">
              <h5 class="card-title">${bookTitle}</h5>
              <p class="card-text"><strong>Author:</strong> ${bookAuthor}</p>
              <p class="card-text"><strong>Borrowed:</strong> ${borrowedDate}</p>
              <p class="card-text"><strong>Due Date:</strong> ${dueDate}</p>
              <span class="badge ${loan.status === 'active' ? 'bg-primary' : 'bg-success'}">
                ${loan.status === 'active' ? 'Active' : 'Returned'}
              </span>
              ${isOverdue ? '<span class="badge bg-danger ms-2">Overdue</span>' : ''}
              ${loan.status === 'active' ? `
                <button class="btn btn-sm btn-success mt-2" onclick="returnBook('${loan._id}')">
                  <i class="bi bi-check-circle"></i> Return Book
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }
  
  // Frontend return book function
  // This function is called when the user clicks the "Return Book" button
  window.returnBook = function(loanId) {
    // Step 1: Confirm with the user before proceeding
    // The confirm() dialog asks "Are you sure?" to prevent accidental returns
    // Only proceed if the user clicks "OK" (returns true)
    if (confirm("Are you sure you want to return this book?")) {
      // Step 2: Send a POST request to the backend API
      // The loanId tells the backend which loan to mark as returned
      // The backend will update both the loan status AND the book's availability
      fetch(`/api/loans/${loanId}/return`, {
        method: "POST"
      })
      .then(res => res.json())
      .then(data => {
        // Step 3: After successful return, update the UI
        // Show a success message to the user
        alert("Book returned successfully!");
        // Refresh the "My Books" page to show the updated loan list
        // This removes the returned book from the active loans display
        loadLoans();
        // Step 4: Notify other pages that a book was returned
        // Dispatch a custom event that the All Books page listens to
        // This allows All Books to automatically refresh and show the book as "Available"
        // Without this, All Books would still show "Borrowed" until the user manually refreshes
        window.dispatchEvent(new CustomEvent('bookReturned'));
      })
      .catch(err => {
        // If the API call fails, show an error message
        alert("Error returning book");
        console.error(err);
      });
    }
    // If user clicks "Cancel" in the confirm dialog, nothing happens
    // The function exits and no API call is made
  };
  
  loadLoans();
});
</script>
{% endblock %}
