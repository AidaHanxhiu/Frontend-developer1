{# Extend the base layout template (navbar, footer, etc.) #}
{% extends "base.html" %}

{# Set the page title shown in the browser tab #}
{% block title %}My Books{% endblock %}

{# Page-specific CSS block #}
{% block extra_css %}
<!-- Link to the My Books page stylesheet -->
<link rel="stylesheet" href="{{ url_for('static', filename='my-books.css') }}">
{% endblock %}

{# Main content block #}
{% block content %}

<!-- Page heading -->
<h1 class="mb-4">My Borrowed Books</h1>

<!-- Container for displaying the user's loans -->
<div id="loansList" class="row">
  <!-- Loan cards will be dynamically loaded here using JavaScript -->
</div>

{# End of main content block #}
{% endblock %}

{# Page-specific JavaScript block #}
{% block extra_js %}
<script>
/* Run JavaScript after the DOM has fully loaded */
document.addEventListener("DOMContentLoaded", function() {

  /* Function to load loans from the backend API */
  function loadLoans() {

    /* Send GET request to retrieve user's loans */
    fetch("/api/loans")

      /* Convert response to JSON */
      .then(res => res.json())

      /* Pass loan data to display function */
      .then(data => {
        displayLoans(data.loans || []);
      })

      /* Log any errors */
      .catch(err => console.error("Error:", err));
  }
  
  /* Function to display loan cards on the page */
  function displayLoans(loans) {

    /* Get reference to the loans container */
    const loansList = document.getElementById("loansList");
    
    /* If the user has no loans */
    if (loans.length === 0) {

      /* Show informational message */
      loansList.innerHTML = `
        <div class="col-12">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> You don't have any loans yet. 
            <a href="{{ url_for('pages.all_books') }}">Browse books</a> to get started!
          </div>
        </div>
      `;

      /* Exit the function */
      return;
    }
    
    /* Generate HTML cards for each loan */
    loansList.innerHTML = loans.map(loan => {

      /* Format borrowed date or show N/A */
      const borrowedDate = loan.borrowed_date
        ? new Date(loan.borrowed_date).toLocaleDateString()
        : 'N/A';

      /* Format due date or show N/A */
      const dueDate = loan.due_date
        ? new Date(loan.due_date).toLocaleDateString()
        : 'N/A';

      /* Check if the loan is overdue */
      const isOverdue =
        loan.due_date &&
        new Date(loan.due_date) < new Date() &&
        loan.status === "active";

      /* Get book title or fallback text */
      const bookTitle =
        loan.book && loan.book.title
          ? loan.book.title
          : 'Unknown Book';

      /* Get book author or fallback text */
      const bookAuthor =
        loan.book && loan.book.author
          ? loan.book.author
          : 'Unknown Author';
      
      /* Return HTML for a single loan card */
      return `
        <div class="col-md-6 mb-3">
          <div class="card ${isOverdue ? 'border-danger' : ''}">
            <div class="card-body">

              <!-- Book title -->
              <h5 class="card-title">${bookTitle}</h5>

              <!-- Book author -->
              <p class="card-text"><strong>Author:</strong> ${bookAuthor}</p>

              <!-- Borrowed date -->
              <p class="card-text"><strong>Borrowed:</strong> ${borrowedDate}</p>

              <!-- Due date -->
              <p class="card-text"><strong>Due Date:</strong> ${dueDate}</p>

              <!-- Loan status badge -->
              <span class="badge ${loan.status === 'active' ? 'bg-primary' : 'bg-success'}">
                ${loan.status === 'active' ? 'Active' : 'Returned'}
              </span>

              <!-- Overdue badge (only if overdue) -->
              ${isOverdue ? '<span class="badge bg-danger ms-2">Overdue</span>' : ''}

              <!-- Return button (only for active loans) -->
              ${loan.status === 'active' ? `
                <button class="btn btn-sm btn-success mt-2"
                        onclick="returnBook('${loan._id}')">
                  <i class="bi bi-check-circle"></i> Return Book
                </button>
              ` : ''}

            </div>
          </div>
        </div>
      `;
    }).join(''); /* Combine all cards into one HTML string */
  }
  
  /* -------------------------------- */
  /* Return Book Function (Frontend)  */
  /* -------------------------------- */

  /* Expose returnBook globally so it can be called from inline HTML */
  window.returnBook = function(loanId) {

    /* Ask user to confirm return action */
    if (confirm("Are you sure you want to return this book?")) {

      /* Send POST request to backend to return the book */
      fetch(`/api/loans/${loanId}/return`, {
        method: "POST"
      })

      /* Convert response to JSON */
      .then(res => res.json())

      /* Handle successful return */
      .then(data => {

        /* Notify user of success */
        alert("Book returned successfully!");

        /* Reload loans list to reflect changes */
        loadLoans();

        /* Notify other pages that a book was returned */
        window.dispatchEvent(new CustomEvent('bookReturned'));
      })

      /* Handle errors */
      .catch(err => {
        alert("Error returning book");
        console.error(err);
      });
    }

    /* If user clicks Cancel, no action is taken */
  };
  
  /* Load loans when the page loads */
  loadLoans();
});
</script>
{% endblock %}
